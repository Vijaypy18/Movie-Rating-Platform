<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favorites - Movie Review Hub</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .movie-card {
            transition: all 0.3s ease;
        }
        
        .movie-card:hover {
            transform: translateY(-5px) scale(1.02);
        }
        
        .movie-poster {
            transition: transform 0.3s ease;
        }
        
        .movie-card:hover .movie-poster {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Header Section -->
    <header class="bg-gray-800 p-5 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold">ðŸŽ¬ Movie Review Hub</h1>
            <nav class="space-x-6">
                <a href="index.html" class="hover:text-purple-400">Home</a>
                <a href="profile.html" class="hover:text-purple-400">Profile</a>
                <a href="movies.html" class="hover:text-purple-400">Movies</a>
                <a href="watchlist.html" class="hover:text-purple-400">Watchlist</a>
                <a href="favorites.html" class="hover:text-purple-400">Favorites</a>
                <button id="auth-btn" class="bg-purple-600 px-4 py-2 rounded">Login/Register</button>
            </nav>
        </div>
    </header>

    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg w-96">
            <!-- Login Form -->
            <div id="login-form">
                <h2 class="text-2xl mb-4 font-bold text-center">Login</h2>
                <input type="email" id="login-email" placeholder="Email" class="w-full p-2 mb-4 bg-gray-700 rounded">
                <input type="password" id="login-password" placeholder="Password" class="w-full p-2 mb-4 bg-gray-700 rounded">
                <button id="submit-login" class="bg-purple-600 w-full py-2 rounded">Login</button>
                <p class="text-sm mt-4 text-center">
                    Don't have an account? <a href="#" id="switch-to-register" class="text-blue-400">Register here</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="hidden">
                <h2 class="text-2xl mb-4 font-bold text-center">Register</h2>
                <input type="text" id="register-username" placeholder="Username" class="w-full p-2 mb-4 bg-gray-700 rounded">
                <input type="email" id="register-email" placeholder="Email" class="w-full p-2 mb-4 bg-gray-700 rounded">
                <input type="password" id="register-password" placeholder="Password" class="w-full p-2 mb-4 bg-gray-700 rounded">
                <button id="submit-register" class="bg-green-600 w-full py-2 rounded">Register</button>
                <p class="text-sm mt-4 text-center">
                    Already have an account? <a href="#" id="switch-to-login" class="text-blue-400">Login here</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Section -->
    <main class="container mx-auto mt-10 p-5">
        <section id="favorites">
            <h2 class="text-4xl font-semibold mb-5 text-center">Your Favorite Movies</h2>
            <div id="favorites-container" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Favorite movies will be displayed here -->
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 p-4 text-center">
        <p>&copy; 2024 Movie Review Hub</p>
    </footer>

    <!-- Axios for API Requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Show/Hide Auth Modal
        const authModal = document.getElementById("auth-modal");
        
        // Open modal from login/register button
        document.getElementById("auth-btn").addEventListener("click", () => {
            const token = localStorage.getItem('token');
            if (token) {
                // Logout functionality
                localStorage.removeItem('token'); // Remove token from localStorage
                alert('You have been logged out.');
                window.location.reload(); // Refresh the page to show login/register button
            } else {
                authModal.classList.remove("hidden");
            }
        });

        // Switch between Login and Register
        document.getElementById("switch-to-register").addEventListener("click", () => {
            document.getElementById("login-form").classList.add("hidden");
            document.getElementById("register-form").classList.remove("hidden");
        });

        document.getElementById("switch-to-login").addEventListener("click", () => {
            document.getElementById("register-form").classList.add("hidden");
            document.getElementById("login-form").classList.remove("hidden");
        });

        // Login Functionality
        document.getElementById("submit-login").addEventListener("click", async () => {
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            try {
                const response = await axios.post("http://localhost:5001/api/auth/login", { email, password });
                alert("Login successful!");
                localStorage.setItem('token', response.data.token); // Save token in localStorage
                authModal.classList.add("hidden");
                window.location.reload(); // Reload page to reflect login
            } catch (error) {
                alert("Login failed!");
                console.error(error);
            }
        });

        // Register Functionality
        document.getElementById("submit-register").addEventListener("click", async () => {
            const username = document.getElementById("register-username").value;
            const email = document.getElementById("register-email").value;
            const password = document.getElementById("register-password").value;
            try {
                const response = await axios.post("http://localhost:5001/api/auth/register", { username, email, password });
                alert("Registration successful!");
                localStorage.setItem('token', response.data.token); // Save token in localStorage
                authModal.classList.add("hidden");
                window.location.reload(); // Reload page to reflect login
            } catch (error) {
                alert("Registration failed!");
                console.error(error);
            }
        });

        // Fetch favorites when page loads
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html'; // Redirect if not logged in
            } else {
                fetchFavorites();
                const authBtn = document.getElementById('auth-btn');
                // If user is logged in, show "Logout" button
                authBtn.textContent = 'Logout';
                authBtn.classList.remove('bg-purple-600');
                authBtn.classList.add('bg-red-600');
            }
        });

        // Fetch favorites from backend
        async function fetchFavorites(page = 1) {
            const favoritesContainer = document.getElementById('favorites-container');
            favoritesContainer.innerHTML = '<p>Loading...</p>'; // Show loading state

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.error('No authentication token found');
                    favoritesContainer.innerHTML = '<p>No authentication token found. Please log in.</p>';
                    return;
                }

                const response = await axios.get(`http://localhost:5001/api/favourites?page=${page}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                renderFavorites(response.data);
                // handlePagination(response.data.pagination); // No pagination for now
            } catch (error) {
                console.error('Failed to fetch favorites:', error);
                favoritesContainer.innerHTML = '<p>Failed to load favorites. Please try again later.</p>';
            }
        }

        // Render favorites to the page
        function renderFavorites(favorites) {
            const favoritesContainer = document.getElementById('favorites-container');
            favoritesContainer.innerHTML = ''; 

            if (favorites.length === 0) {
                favoritesContainer.innerHTML = `
                    <div class="col-span-full text-center text-gray-400">
                        <p>No favorite movies yet. Start adding some!</p>
                    </div>
                `;
                return;
            }

            favorites.forEach(movie => {
                const movieCard = document.createElement('div');
                movieCard.classList.add(
                    'bg-gray-800', 
                    'rounded-lg', 
                    'overflow-hidden', 
                    'shadow-lg', 
                    'transform', 
                    'transition', 
                    'hover:scale-105'
                );

                const posterUrl = movie.poster && movie.poster.startsWith('/') 
                    ? `https://image.tmdb.org/t/p/w500${movie.poster}` 
                    : movie.poster || '/placeholder-movie.png';
                
                movieCard.innerHTML = `
                    <div class="relative group">
                        <img 
                            src="${posterUrl}" 
                            alt="${movie.title}" 
                            class="movie-poster w-full h-96 object-cover"
                        >
                        <!-- Hover overlay -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4">
                            <h4 class="text-white font-bold text-lg mb-2">${movie.title}</h4>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center text-yellow-400">
                                    <i class="fas fa-star mr-1"></i>
                                    <span>${movie.rating}</span>
                                </div>
                                <span class="text-gray-300">${movie.year}</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="text-xl font-bold mb-2">${movie.title}</h3>
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-yellow-500">
                                <i class="fas fa-star"></i> ${movie.rating}
                            </span>
                            <span class="text-gray-400">${movie.year}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button 
                                onclick="removeFromFavorites('${movie._id}', this)" 
                                class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-500 transition-colors flex-1"
                            >
                                <i class="fas fa-trash mr-1"></i>Remove
                            </button>
                            <button 
                                onclick="viewMovieDetails('${movie._id}')" 
                                class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-500 transition-colors flex-1"
                            >
                                <i class="fas fa-info mr-1"></i>Details
                            </button>
                        </div>
                    </div>
                `;

                favoritesContainer.appendChild(movieCard);
            });
        }

        // Handle pagination
        function handlePagination(pagination) {
            const paginationContainer = document.getElementById('pagination-container');
            paginationContainer.innerHTML = ''; // Clear previous pagination

            if (pagination.totalPages > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = 'Previous';
                prevButton.classList.add('bg-gray-600', 'text-white', 'px-4', 'py-2', 'rounded', 'mr-2');
                prevButton.disabled = pagination.currentPage === 1;
                prevButton.onclick = () => fetchFavorites(pagination.currentPage - 1);

                const nextButton = document.createElement('button');
                nextButton.textContent = 'Next';
                nextButton.classList.add('bg-gray-600', 'text-white', 'px-4', 'py-2', 'rounded');
                nextButton.disabled = pagination.currentPage === pagination.totalPages;
                nextButton.onclick = () => fetchFavorites(pagination.currentPage + 1);

                paginationContainer.appendChild(prevButton);
                paginationContainer.appendChild(nextButton);
            }
        }

        // Remove movie from favorites and UI
        async function removeFromFavorites(movieId, button) {
            const confirmation = confirm('Are you sure you want to remove this movie from favorites?');
            if (!confirmation) return;

            try {
                const token = localStorage.getItem('token');
                await axios.delete(`http://localhost:5001/api/favourites/${movieId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                // Remove the movie card from the UI directly
                const movieCard = button.closest('div');
                movieCard.remove();
                alert('Movie removed from favorites!');
            } catch (error) {
                console.error('Failed to remove from favorites:', error);
                alert('Could not remove movie from favorites');
            }
        }

        // View movie details
        async function viewMovieDetails(movieId) {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`http://localhost:5001/api/movies/${movieId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                openMovieDetailsModal(response.data);
            } catch (error) {
                console.error('Failed to fetch movie details:', error);
                alert('Failed to fetch movie details. Please try again later.');
            }
        }

        // Open movie details modal
        function openMovieDetailsModal(movie) {
            const modalHtml = `
                <div id="movie-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-gray-800 p-6 rounded-lg max-w-md relative">
                        <button 
                            onclick="closeMovieDetailsModal()" 
                            class="absolute top-2 right-2 text-white hover:text-red-500"
                        >
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                        <h2 class="text-2xl font-bold mb-4">${movie.title}</h2>
                        <img src="${movie.poster}" alt="${movie.title}" class="w-full mb-4">
                        <p class="mb-4">${movie.description}</p>
                        <div class="flex justify-between mb-4">
                            <span>Rating: ${movie.rating}/10</span>
                            <span>Year: ${movie.year}</span>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // Close movie details modal
        function closeMovieDetailsModal() {
            const modal = document.getElementById('movie-details-modal');
            if (modal) {
                modal.remove();
            }
        }
    </script>
</body>
</html>
